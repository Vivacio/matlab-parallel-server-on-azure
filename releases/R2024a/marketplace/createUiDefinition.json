{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "text1",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                    "text": "Need help?",
                    "link": {
                        "label": " Click here for instructions",
                        "uri": "https://www.mathworks.com/help/cloudcenter/ug/run-matlab-parallel-server-from-azure-marketplace.html"
                    }
                }
            }
        ],
        "steps": [
            {
                "name": "ClusterConfig",
                "label": "Cluster Settings",
                "subLabel": {
                    "preValidation": "Configure virtual machine resources and settings",
                    "postValidation": "Done"
                },
                "bladeTitle": "Cluster Settings",
                "elements": [
                    {
                        "name": "clusterName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Cluster Name",
                        "toolTip": "A name to use for this cluster. This name is shown in MATLAB as the cluster profile name.",
                        "defaultValue": "myCluster",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z][a-zA-Z0-9 _]{1,62}$",
                            "validationMessage": "Cluster name can only include letters, number, spaces and underscores. It must start with a letter and can be no more than 63 characters."
                        }
                    },
                    {
                        "name": "numWorkerNodes",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Num Worker Nodes",
                        "toolTip": "The number of Azure virtual machines to start for the workers to run on.",
                        "defaultValue": "2",
                        "constraints": {
                            "required": true,
                            "regex": "^([1-9][0-9]{0,2}|1000|0){1,1}$",
                            "validationMessage": "Num Worker Nodes must be a positive integer between 1-1000."
                        }
                    },
                    {
                        "name": "minWorkerNodes",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Min Worker Nodes",
                        "toolTip": "Minimum number of running Azure virtual machines.",
                        "defaultValue": "0",
                        "constraints": {
                            "required": true,
                            "regex": "^(0|[1-9][0-9]{0,2}|1000){1,1}$",
                            "validationMessage": "Min Worker Nodes must be a positive integer between 0-1000."
                        }
                    },
                    {
                        "name": "maxWorkerNodes",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Max Worker Nodes",
                        "toolTip": "Maximum number of running Azure virtual machines.",
                        "defaultValue": "4",
                        "constraints": {
                            "required": true,
                            "regex": "^([1-9][0-9]{0,2}|1000){1,1}$",
                            "validationMessage": "Max Worker Nodes must be a positive integer between 1-1000."
                        }
                    },
                    {
                        "name": "numWorkersPerNode",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Num Worker Per Node",
                        "toolTip": "The number of MATLAB workers to start on each virtual machine. Specify 1 worker for every 2 vCPUs, because this results in 1 worker per physical core. For example a Standard_D64s_v3 instance has 64 vCPUs, so can support 32 MATLAB workers. See https://learn.microsoft.com/azure/virtual-machines/sizes for details on vCPUs for each virtual machine type.",
                        "defaultValue": "2",
                        "constraints": {
                            "required": true,
                            "regex": "^([1-9][0-9]{0,2}|1000){1,1}$",
                            "validationMessage": "Num Worker Per Node must be a positive integer between 1-1000."
                        }
                    },
                    {
                        "name": "headnodevmSize",
                        "type": "Microsoft.Compute.SizeSelector",
                        "label": "Headnode Instance Type",
                        "toolTip": "The Azure virtual machine size to use for the head node, which runs the job manager. No workers are started on this node, so this can be a smaller virtual machine than the worker nodes. By default, the heap memory for the job manager is set between 1024 MiB and a maximum of half of the virtual machine memory, depending on the total number of MATLAB workers. See https://learn.microsoft.com/azure/virtual-machines/sizes for a list of virtual machines.",
                        "recommendedSizes": [
                            "Standard_D4s_v3"
                        ],
                        "osPlatform": "Windows",
                        "count": "1"
                    },
                    {
                        "name": "workervmSize",
                        "type": "Microsoft.Compute.SizeSelector",
                        "label": "Worker Instance Type",
                        "toolTip": "The Azure virtual machine size to use for the workers. By default, the heap memory for all worker process is set between 1024 MiB and a maximum of a quarter of the instance memory, depending on the number of MATLAB workers on the VM. See https://learn.microsoft.com/azure/virtual-machines/sizes for a list of virtual machines.",
                        "recommendedSizes": [
                            "Standard_F4s_v2"
                        ],
                        "osPlatform": "Windows",
                        "count": "1"
                    },
                    {
                        "name": "databaseVolumeSize",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Database Volume Size",
                        "toolTip": "The size of the volume in Gigabytes used to store the database files. If set to 0, a separate volume is not created and the root volume is used for the database.",
                        "defaultValue": "100",
                        "constraints": {
                            "required": true,
                            "regex": "^(0|[1-9][0-9]{0,2}|10[0-1][0-9]|102[0-3]){1,1}$",
                            "validationMessage": "Database Volume Size must be a positive integer between 0-1023."
                        }
                    },
                    {
                        "name": "clientIPAddress",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Client IP Address",
                        "toolTip": "The IP address range that can be used to access the cluster from MATLAB. This must be a valid IP CIDR range of the form x.x.x.x/x. Use the value your_public_ip_address/32 to restrict access to only your computer.",
                        "defaultValue": "",
                        "constraints": {
                            "required": true,
                            "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?.{1,1}$",
                            "validationMessage": "Address must use valid CIDR notation. For example: 192.168.100.14/24"
                        }
                    },
                    {
                        "name": "adminUsername",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Admin Username",
                        "toolTip": "Admin username for the cluster. Must be at least 6 characters long and start with an alphabet. To avoid any deployment errors, check the list of [disallowed values](https://learn.microsoft.com/rest/api/compute/virtual-machines/create-or-update?tabs=HTTP#osprofile) for Admin Username.",
                        "defaultValue": "matlab",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z]{6,20}$",
                            "validationMessage": "The username must be at least 6 characters long and should start with an alphabet."
                        }
                    },
                    {
                        "name": "adminPassword",
                        "type": "Microsoft.Common.PasswordBox",
                        "label": {
                            "password": "Password",
                            "confirmPassword": "Confirm Password"
                        },
                        "toolTip": "Choose the password for the admin user of the cluster. This password and the chosen admin username are required to login into any instance in the cluster using RDP. For the deployment to succeed, your password must meet Azure's password requirements. See [Password requirements when creating a VM](https://learn.microsoft.com/azure/virtual-machines/windows/faq?WT.mc_id=Portal-fx#what-are-the-password-requirements-when-creating-a-vm-) for information on the password requirements.",
                        "constraints": {
                            "required": true,
                            "regex": "^((?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])|(?=.*[0-9])(?=.*[a-z])(?=.*[!@#$%^&*])|(?=.*[0-9])(?=.*[A-Z])(?=.*[!@#$%^&*])|(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*])).{12,72}$",
                            "validationMessage": "Password must be at least 12 characters long and have 3 out of the following: one number, one lower case, one upper case, or one special character"
                        },
                        "options": {
                            "hideConfirmation": false
                        },
                        "visible": true
                    },
                    {
                        "name": "licenseServer",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Network License Manager (Optional)",
                        "defaultValue": "",
                        "toolTip": "Port and hostname or IP address of the virtual machine hosting your Network License Manager.  For example: 27001@10.0.0.1.",
                        "constraints": {
                            "required": false,
                            "regex": "^([1-9][0-9]{0,4}@[0-9.a-zA-Z]+){1,1}$",
                            "validationMessage": "Port number must be followed by a valid ip address."
                        },
                        "visible": true
                    },
                    {
                        "name": "MJSSecurityLevel",
                        "type": "Microsoft.Common.DropDown",
                        "label": "MJS Security Level",
                        "defaultValue": "0",
                        "toolTip": "Security level for the cluster. Level 0: Any user can access any jobs and tasks. Level 1: Accessing other users' jobs and tasks issues a warning. However, all users can still perform all actions. Level 2: Users must enter a password to access their jobs and tasks. The job owner can grant access to other users.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "0",
                                    "value": "0"
                                },
                                {
                                    "label": "1",
                                    "value": "1"
                                },
                                {
                                    "label": "2",
                                    "value": "2"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "enableAutoscaling",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Enable Autoscaling",
                        "defaultValue": "No",
                        "toolTip": "Option indicating whether instance autoscaling is enabled. If you enable autoscaling, the number of workers fluctuates between Min Worker Nodes and Max Worker Nodes depending on the number of workers the cluster needs. Ensure that the Max Worker Nodes parameter is within your Azure subscription quotas for the specific instance type. To learn about setting quotas, see https://learn.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Yes",
                                    "value": "Yes"
                                },
                                {
                                    "label": "No",
                                    "value": "No"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "MJSSchedulingAlgorithm",
                        "type": "Microsoft.Common.DropDown",
                        "label": "MJS Scheduling Algorithm",
                        "defaultValue": "No",
                        "toolTip": "Scheduling algorithm for the job manager. 'standard' spreads communicating jobs across as few worker machines as possible to reduce communication overheads and fills in unused spaces on worker machines with independent jobs. Suitable for good behaviour for a wide range of uses including autoscaling. 'loadBalancing' distributes load evenly across the cluster to give as many resources as possible to running jobs and tasks when the cluster is underutilized.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Standard",
                                    "value": "standard"
                                },
                                {
                                    "label": "Load Balancing",
                                    "value": "loadBalancing"
                                }
                            ],
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "text1",
                        "type": "Microsoft.Common.InfoBox",
                        "visible": true,
                        "options": {
                            "icon": "Info",
                            "text": "Click here for more information about the Network License Manager on mathworks.com.",
                            "uri": "https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html"
                        }
                    },
                    {
                        "name": "text2",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Need help?",
                            "link": {
                                "label": " Click here for instructions",
                                "uri": "https://www.mathworks.com/help/cloudcenter/ug/run-matlab-parallel-server-from-azure-marketplace.html"
                            }
                        }
                    }
                ]
            },
            {
                "name": "networking",
                "label": "Networking",
                "subLabel": {
                    "preValidation": "Configure virtual network resources and settings",
                    "postValidation": "Done"
                },
                "bladeTitle": "Virtual Network",
                "elements": [
                    {
                        "name": "virtualNetwork",
                        "type": "Microsoft.Network.VirtualNetworkCombo",
                        "label": {
                            "virtualNetwork": "Virtual network",
                            "subnets": "Subnets"
                        },
                        "toolTip": {
                            "virtualNetwork": "Name of the Virtual Network resource to use. By default a new resource is created and added to the resource group.",
                            "subnets": "A subnet is a range of IP addresses in your virtual network, which can be used to isolate virtual machines from each other or from the Internet."
                        },
                        "defaultValue": {
                            "name": "vnet01",
                            "addressPrefixSize": "/16"
                        },
                        "constraints": {
                            "minAddressPrefixSize": "/16"
                        },
                        "options": {
                            "hideExisting": false
                        },
                        "subnets": {
                            "subnet1": {
                                "label": "Subnet",
                                "defaultValue": {
                                    "name": "subnet-1",
                                    "addressPrefixSize": "/24"
                                },
                                "constraints": {
                                    "minAddressPrefixSize": "/24",
                                    "minAddressCount": 12,
                                    "requireContiguousAddresses": true
                                }
                            }
                        },
                        "visible": true
                    },
                    {
                        "name": "text3",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Need help?",
                            "link": {
                                "label": " Click here for instructions",
                                "uri": "https://www.mathworks.com/help/cloudcenter/ug/run-matlab-parallel-server-from-azure-marketplace.html"
                            }
                        }
                    }
                ]
            }
        ],
        "outputs": {
            "location": "[location()]",
            "clusterName": "[steps('ClusterConfig').clusterName]",
            "numWorkerNodes": "[int(steps('ClusterConfig').numWorkerNodes)]",
            "minWorkerNodes": "[int(steps('ClusterConfig').minWorkerNodes)]",
            "maxWorkerNodes": "[int(steps('ClusterConfig').maxWorkerNodes)]",
            "numWorkersPerNode": "[int(steps('ClusterConfig').numWorkersPerNode)]",
            "headnodevmSize": "[steps('ClusterConfig').headnodevmSize]",
            "workervmSize": "[steps('ClusterConfig').workervmSize]",
            "databaseVolumeSize": "[int(steps('ClusterConfig').databaseVolumeSize)]",
            "adminUsername": "[steps('ClusterConfig').adminUsername]",
            "adminPassword": "[steps('ClusterConfig').adminPassword]",
            "licenseServer": "[steps('ClusterConfig').licenseServer]",
            "MJSSecurityLevel": "[steps('ClusterConfig').MJSSecurityLevel]",
            "enableAutoscaling": "[steps('ClusterConfig').enableAutoscaling]",
            "MJSSchedulingAlgorithm": "[steps('ClusterConfig').MJSSchedulingAlgorithm]",
            "clientIPAddress": "[steps('ClusterConfig').clientIPAddress]",
            "virtualNetworkNewOrExisting": "[steps('networking').virtualNetwork.newOrExisting]",
            "virtualNetworkName": "[steps('networking').virtualNetwork.name]",
            "addressPrefix": "[steps('networking').virtualNetwork.addressPrefixes]",
            "subnetName": "[steps('networking').virtualNetwork.subnets.subnet1.name]",
            "subnetPrefix": "[steps('networking').virtualNetwork.subnets.subnet1.addressPrefix]",
            "virtualNetworkResourceGroupName": "[steps('networking').virtualNetwork.resourceGroup]"
        }
    }
}
